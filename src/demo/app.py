import streamlit as st
import requests
import os

# --- 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
st.set_page_config(page_title="Job Optimizer MVP", layout="wide", page_icon="üöÄ")

# –ë–ï–†–ï–ú URL –ò–ó .ENV –ò–õ–ò –ò–°–ü–û–õ–¨–ó–£–ï–ú LOCALHOST (–µ—Å–ª–∏ –∑–∞–ø—É—Å–∫ –±–µ–∑ Docker)
API_URL = os.getenv("BACKEND_URL", "http://127.0.0.1:8000/optimize")

# --- 2. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–µ–π (Session State) ---
if 'in_profile' not in st.session_state: st.session_state['in_profile'] = ""
if 'in_city' not in st.session_state: st.session_state['in_city'] = ""
if 'in_spec' not in st.session_state: st.session_state['in_spec'] = ""
if 'in_title' not in st.session_state: st.session_state['in_title'] = ""
if 'in_desc' not in st.session_state: st.session_state['in_desc'] = ""

st.title("üöÄ Job Optimizer: –£–ª—É—á—à–µ–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–π")
st.markdown("–°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –≤–∞–∫–∞–Ω—Å–∏–π –∏ –ø–µ—Ä–µ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è –º–∞–∫—Å–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç–∫–ª–∏–∫–æ–≤.")

# --- 3. –°–∞–π–¥–±–∞—Ä —Å —à–∞–±–ª–æ–Ω–∞–º–∏ ---
with st.sidebar:
    st.header("üìù –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö")
    st.write("–í—ã–±–µ—Ä–∏—Ç–µ —Ä–µ–∞–ª—å–Ω—ã–π –ø—Ä–∏–º–µ—Ä –∏–∑ –±–∞–∑—ã:")


    def load_template(profile, city, spec, title, desc):
        st.session_state['in_profile'] = profile
        st.session_state['in_city'] = city
        st.session_state['in_spec'] = spec
        st.session_state['in_title'] = title
        st.session_state['in_desc'] = desc


    # –ö–Ω–æ–ø–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤
    col1, col2 = st.columns(2)

    with col1:
        # –ü–†–ò–ú–ï–† 1: –ü–Ø–¢–ï–†–û–ß–ö–ê (–ò–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞)
        if st.button("üçè –ü—è—Ç–µ—Ä–æ—á–∫–∞"):
            load_template(
                profile="–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä",
                city="–ú–æ—Å–∫–≤–∞",
                spec="–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –ø—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä",
                title="–ü—Ä–æ–¥–∞–≤–µ—Ü (–ú–æ—Å–∫–≤–∞, –®–µ–ª–µ–ø–∏—Ö–∏–Ω—Å–∫–∞—è, 40)",
                desc="""¬´–ü—è—Ç–µ—Ä–æ—á–∫–∞¬ª –ø—Ä–∏–≥–ª–∞—à–∞–µ—Ç –Ω–∞ –≤–∞–∫–∞–Ω—Å–∏—é: –ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä

–û–¢ –ù–ê–°:
- –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –ø–æ –¢–ö –†–§
- –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –æ–∫–ª–∞–¥ + –ø—Ä–µ–º–∏–∏ –∏ –Ω–∞–¥–±–∞–≤–∫–∏ –∑–∞ —Å—Ç–∞–∂. –°—Ä–µ–¥–Ω–∏–π –¥–æ—Ö–æ–¥ 80000 ‚Äì 100000 —Ä—É–±. –≤ –º–µ—Å—è—Ü –¥–æ –≤—ã—á–µ—Ç–∞ –Ω–∞–ª–æ–≥–æ–≤
- –ì—Ä–∞—Ñ–∏–∫ —Ä–∞–±–æ—Ç—ã 2/2, 5/2, –Ω–µ–ø–æ–ª–Ω—ã–π —Ä–∞–±–æ—á–∏–π –¥–µ–Ω—å, –ø–æ–¥—Ä–∞–±–æ—Ç–∫–∞ (–æ—Ç 4 —á–∞—Å–æ–≤)
- –ú–µ–¥–∫–Ω–∏–∂–∫–∞ –∑–∞ —Å—á–µ—Ç –∫–æ–º–ø–∞–Ω–∏–∏
- –°–∫–∏–¥–∫–∞ 5% –≤ –º–∞–≥–∞–∑–∏–Ω–∞—Ö ¬´–ü—è—Ç—ë—Ä–æ—á–∫–∞¬ª, ¬´–ü–µ—Ä–µ–∫—Ä—ë—Å—Ç–æ–∫¬ª, ¬´–ö–∞—Ä—É—Å–µ–ª—å¬ª

–ß–¢–û –ù–£–ñ–ù–û –î–ï–õ–ê–¢–¨:
- –û–±—Å–ª—É–∂–∏–≤–∞—Ç—å –≥–æ—Å—Ç–µ–π –Ω–∞ –∫–∞—Å—Å–µ
- –í—ã–∫–ª–∞–¥—ã–≤–∞—Ç—å —Ç–æ–≤–∞—Ä –≤ –∑–∞–ª–µ
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å —Å—Ä–æ–∫–∏ –≥–æ–¥–Ω–æ—Å—Ç–∏ –∏ —Ü–µ–Ω–Ω–∏–∫–∏"""
            )

    with col2:
        # –ü–†–ò–ú–ï–† 2: –ú–ê–ì–ù–ò–¢ (–ò–∑ –≤–∞—à–µ–≥–æ —Ñ–∞–π–ª–∞)
        if st.button("üî¥ –ú–∞–≥–Ω–∏—Ç"):
            load_template(
                profile="–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä",
                city="–ú–æ—Å–∫–≤–∞",
                spec="–ü—Ä–æ–¥–∞–≤–µ—Ü-–∫–æ–Ω—Å—É–ª—å—Ç–∞–Ω—Ç, –ø—Ä–æ–¥–∞–≤–µ—Ü-–∫–∞—Å—Å–∏—Ä",
                title="–ü—Ä–æ–¥–∞–≤–µ—Ü (–ú–æ—Å–∫–≤–∞, –ü–∞–≤–ª–∞ –ö–æ—Ä—á–∞–≥–∏–Ω–∞, 16)",
                desc="""–®–∏—Ä–æ–∫–∞—è —Å–µ—Ç—å –º–∞–≥–∞–∑–∏–Ω–æ–≤ ¬´–ú–∞–≥–Ω–∏—Ç¬ª ‚Äî —ç—Ç–æ –Ω–µ –ø—Ä–æ—Å—Ç–æ —Ä–∞–±–æ—Ç–∞ —Ä—è–¥–æ–º —Å –¥–æ–º–æ–º. –≠—Ç–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å –∏–∑ –≤—Å–µ—Ö –º–∞–≥–∞–∑–∏–Ω–æ–≤ —Ç–æ—Ç, –∫–æ—Ç–æ—Ä—ã–π –±–ª–∏–∂–µ –≤—Å–µ–≥–æ –∫ —Å–µ–º—å–µ –∏ –¥–µ—Ç—è–º.

–†–∞–±–æ—Ç–∞–π –≤ ¬´–ú–∞–≥–Ω–∏—Ç–µ¬ª –∏ –ø–æ–ª—É—á–∞–π:
- –°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≥–∞—Ä–∞–Ω—Ç–∏–∏ –∏ –±–µ–ª–∞—è –∑–∞—Ä–ø–ª–∞—Ç–∞
- –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤–ª–∏—è—Ç—å –Ω–∞ —Å–≤–æ–π –¥–æ—Ö–æ–¥
- –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –æ–±—É—á–µ–Ω–∏–µ –∏ –º–µ–¥–æ—Å–º–æ—Ç—Ä
- –ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ —Å–∫–∏–¥–∫–∏

–û–±—è–∑–∞–Ω–Ω–æ—Å—Ç–∏:
- –í—ã–∫–ª–∞–¥–∫–∞ —Ç–æ–≤–∞—Ä–∞ –≤ —Ç–æ—Ä–≥–æ–≤–æ–º –∑–∞–ª–µ
- –ö–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–ª–∏—á–∏—è —Ü–µ–Ω–Ω–∏–∫–æ–≤
- –û–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª–µ–π –Ω–∞ –∫–∞—Å—Å–µ
- –£—á–∞—Å—Ç–∏–µ –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–∏–∑–∞—Ü–∏—è—Ö

–ú—ã –∂–¥–µ–º –∏–º–µ–Ω–Ω–æ —Ç–µ–±—è, –µ—Å–ª–∏ —Ç—ã —Ö–æ—á–µ—à—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤ –¥—Ä—É–∂–Ω–æ–π –∫–æ–º–∞–Ω–¥–µ!"""
            )

    st.divider()

    # --- –§–û–†–ú–ê –í–í–û–î–ê ---
    with st.form("main_form"):
        profile = st.text_input("–ü—Ä–æ—Ñ–∏–ª—å", key='in_profile')
        city = st.text_input("–ì–æ—Ä–æ–¥", key='in_city')
        specialization = st.text_input("–°–ø–µ—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è", key='in_spec')
        title = st.text_input("–ó–∞–≥–æ–ª–æ–≤–æ–∫ –≤–∞–∫–∞–Ω—Å–∏–∏", key='in_title')
        description = st.text_area("–û–ø–∏—Å–∞–Ω–∏–µ –≤–∞–∫–∞–Ω—Å–∏–∏", height=350, key='in_desc')

        submit = st.form_submit_button("‚ö° –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤–∞–∫–∞–Ω—Å–∏—é", type="primary")

# --- 4. –õ–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ ---
if submit:
    if not (title and description):
        st.error("‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ö–æ—Ç—è –±—ã –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –û–ø–∏—Å–∞–Ω–∏–µ!")
    else:
        with st.spinner("ü§ñ –ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä—ã–Ω–æ–∫ –∏ –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —É–ª—É—á—à–µ–Ω–∏—è..."):
            payload = {
                "vacancies": [{
                    "input_id": "demo_real",
                    "profile": profile,
                    "city": city,
                    "specialization": specialization,
                    "vacancy_title": title,
                    "vacancy_description": description
                }]
            }

            try:
                response = requests.post(API_URL, json=payload)
                response.raise_for_status()
                data = response.json()

                if not data["results"]:
                    st.error("–û—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ –ø—É—Å—Ç–æ–π.")
                else:
                    res = data["results"][0]

                    st.subheader("‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏")

                    c_orig, c_new = st.columns(2)

                    with c_orig:
                        st.info("üìÑ –ë—ã–ª–æ")
                        st.text_input("–°—Ç–∞—Ä—ã–π Title", title, disabled=True)
                        st.text_area("–°—Ç–∞—Ä–æ–µ Desc", description, height=500, disabled=True)

                    with c_new:
                        st.success("‚ú® –°—Ç–∞–ª–æ")
                        st.text_input("–ù–æ–≤—ã–π Title", res['vacancy_title'])
                        st.text_area("–ù–æ–≤–æ–µ Desc", res['vacancy_description'], height=500)

                    with st.expander("üí° –ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –ò–ò (Improvement Notes)", expanded=True):
                        if res.get('improvement_notes'):
                            for note in res['improvement_notes']:
                                st.write(f"- {note}")
                        else:
                            st.write("–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —É–ª—É—á—à–µ–Ω–∞ –¥–ª—è –ø–æ–≤—ã—à–µ–Ω–∏—è —á–∏—Ç–∞–µ–º–æ—Å—Ç–∏.")

            except Exception as e:
                st.error(f"‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: {e}")
                st.warning("–ü—Ä–æ–≤–µ—Ä—å—Ç–µ, –∑–∞–ø—É—â–µ–Ω –ª–∏ backend: python -m src.api.main")

else:
    st.info("üëà –í—ã–±–µ—Ä–∏—Ç–µ —à–∞–±–ª–æ–Ω —Å–ª–µ–≤–∞ (–ü—è—Ç–µ—Ä–æ—á–∫–∞ / –ú–∞–≥–Ω–∏—Ç) –¥–ª—è —Ç–µ—Å—Ç–∞.")
